# 智能考勤小程序开发规划

> 依据 `doc_01_overview.md` ~ `doc_06_common.md` 及 `UI设计/` 目录提供的界面稿整理，补足全局规划。项目源码统一落在 `realize/` 目录，采用原生微信小程序 + 云开发（Cloud Functions + 云数据库）方案，必要时可接入自建 Node 服务。

## 1. 项目定位与目标
- 面向学生、教师、辅导员、教务管理员 4 类角色，覆盖签到、流程审批、统计分析与系统配置的全链路。
- 用 3 步内完成签到、动态二维码 + 定位 + 人脸多因子验证来防作弊。
- 所有考勤数据沉淀到云端，提供实时监控和历史分析，并输出预警/通知。

## 2. 功能范围概览
| 角色 | 核心能力 | 关键界面 |
| --- | --- | --- |
| 学生 | 日程/签到、补签申请、考勤记录、消息 | 首页、签到页、补签申请、消息中心、个人设置 |
| 教师 | 课程管理、发起签到、实时监控、手动签到、补签审批、统计导出 | 课程列表、发起签到、签到监控、补签审批、课程统计 |
| 辅导员 | 年级/班级总览、预警学生、跟进记录、公假审批、报表导出 | 出勤大盘、预警列表、学生档案、报表中心 |
| 管理员 | 用户/课程/班级管理、权限配置、系统监控、日志与推送管理 | 系统设置、用户管理、课程管理、报表、日志 |
| 公共 | 登录授权、多角色切换、通知中心、数据可视化、日志与审计 | 登录/绑定、角色切换、消息与通知、统计大屏 |

## 3. 技术方案
### 3.1 前端
- **框架**：原生小程序 + TypeScript，结构按 `app` + 4 个分包（student/teacher/counselor/admin），公共组件封装在 `components/`。
- **状态管理**：`@tencent/wa-state` 或自建 `store`（基于 Behavior + event bus），缓存核心数据（课程、签到记录）。
- **网络层**：统一 `request` 封装，添加 token、角色信息、错误处理与重试。
- **UI**：沿用 `UI设计/` 里的色板与组件（卡片、表格、图表），少量适配成小程序组件（例如 `message-card`、`stats-panel`）。

### 3.2 云端/后端
- **云函数**：`auth`, `attendance`, `course`, `statistics`, `notification`, `admin` 六大函数，内部再按 action 路由。
- **云数据库**：集合按下表。
- **存储**：COS/云存储存放人脸模板、证明材料。
- **定时任务**：云函数 + 定时触发器实现预警扫描、报表生成、二维码批次清理。

### 3.3 数据模型（核心集合）
| 集合 | 关键字段 | 说明 |
| --- | --- | --- |
| `users` | `_id`, `role`, `profile`, `faceStatus`, `status` | 基础用户表，含角色映射与人脸状态 |
| `courses` | `courseId`, `teacherId`, `schedule`, `location`, `defaultMode` | 课程与班级绑定 |
| `enrollments` | `courseId`, `studentId`, `status` | 选课/退课关系 |
| `sign_batches` | `batchId`, `courseId`, `mode`, `qrSeed`, `location`, `start/end` | 每次签到批次及参数 |
| `sign_records` | `recordId`, `batchId`, `userId`, `status`, `location`, `faceScore`, `source` | 学生签到记录及验证数据 |
| `makeup_requests` | `recordId`, `studentId`, `type`, `reason`, `attachments`, `status`, `approver` | 补签申请全流程 |
| `alerts` | `alertId`, `level`, `studentId`, `reason`, `followUps` | 预警学生记录 |
| `messages` | `targetId`, `targetRole`, `type`, `payload`, `readStatus` | 站内消息/推送 |
| `logs` | `operatorId`, `action`, `payload`, `timestamp` | 操作/安全日志 |

## 4. UI 及交互基线
- 统一色彩：主色 #2C7CF1、预警黄 #FFB020、异常红 #F24822，对应 `UI设计/styles/tokens`.  
- 组件优先复用 `UI设计/components/ui/` 里的 card、list、chart，必要时转为自定义组件。  
- 表单交互遵循「先定位/扫码，再反馈」顺序，所有长流程提供进度指示器。  
- 列表支持状态标签 + 快速操作（划动/长按），统计页面增加趋势图、对比条。  

## 5. 迭代策略（预估 3 周）
1. **Sprint 0 - 基础设施（2 日）**  
   - 初始化 `realize/` 小程序工程（目录、分包、全局样式、请求封装、模拟数据）。  
   - 接入云开发环境，完成 `users`、`courses`、`sign_batches`、`sign_records` 四个集合初始化。  
2. **Sprint 1 - 核心考勤闭环（6 日）**  
   - 学生端：课程日程、签到页、签到结果、补签申请。  
   - 教师端：课程列表、发起签到、实时监控、手动签到。  
   - 公共：登录/角色切换、消息中心雏形、二维码生成/校验云函数。  
   - 单元测试：云函数逻辑 + 前端关键 util。  
3. **Sprint 2 - 管理与分析（7 日）**  
   - 辅导员：出勤大盘、预警学生、跟进记录。  
   - 管理员：用户/课程管理、角色配置、批量导入导出。  
   - 数据统计：图表组件、报表导出、预警定时任务。  
   - 补签审批全流程、通知推送。  
4. **Sprint 3 - 优化与验收（3 日）**  
   - 性能优化、体验打磨、权限/日志补全，完成联调与演示版本打包。  

## 6. 任务拆解（Realize 目录待办）
1. `realize/app`：配置全局主题、角色切换逻辑、公共导航。  
2. `realize/miniprogram/student` 分包  
   - `pages/home`：今日课程+统计+提醒  
   - `pages/sign`：定位/扫码/人脸流程、异常提示  
   - `pages/makeup`：补签申请表单+记录  
3. `realize/miniprogram/teacher` 分包  
   - `pages/courses`、`pages/sign-launch`、`pages/sign-monitor`、`pages/approval`  
4. `realize/miniprogram/counselor`：出勤总览、预警列表、学生档案  
5. `realize/miniprogram/admin`：用户/课程/班级管理、日志、推送配置  
6. `cloudfunctions`  
   - `auth`：登录绑定、角色切换  
   - `attendance`：发起/结束签到、记录写入、防作弊校验  
   - `statistics`：多维统计、预警扫描  
   - `notification`：消息模板、批量推送  
7. 自动化：`/scripts/deploy.js` 统一部署云函数，`/tests/` 编写云函数 UT（使用 `miniprogram-simulate` 或 `jest` + mock）。  

## 7. 风险与应对
- **人脸识别接入**：若校方暂不提供 SDK，先做「活体检测占位 + 提示“待学校接入”」，接口层保留抽象。  
- **定位精度不足**：结合 WiFi/BLE 或给教师端提供“手动批量签到”作为兜底。  
- **多角色体验复杂**：所有角色页面独立分包，入口统一在首页顶部 Role Switch，避免混淆。  
- **数据一致性**：签到批次 + 记录写入采用事务/原子操作，并对二维码 seed 做一次性校验。  
- **时间紧迫**：优先交付学生+教师闭环；辅导员/管理员模块可在 Sprint 2 逐步上线。  

---
规划完成后，后续开发工作将严格按上述迭代与目录执行，优先保证 `realize/` 中的学生/教师核心链路交付，再扩展管理与分析模块。
