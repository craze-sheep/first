# 智能考勤小程序 - 公共功能与业务流程

## 一、登录与授权

### 1.1 微信快捷登录
**登录流程**：
1. 用户打开小程序
2. 请求微信授权
3. 获取微信用户信息
4. 绑定学校账号（首次使用）
5. 登录成功，进入首页

### 1.2 账号绑定
**首次使用绑定**：
- 输入姓名
- 输入学号/工号
- 系统验证身份
- 绑定微信账号

**绑定方式**：
- 手动输入信息
- 扫描学生证/工作证二维码
- 从教务系统同步

### 1.3 多角色切换
**场景**：
- 教师同时是辅导员
- 管理员同时是教师
- 学生担任助教

**切换功能**：
- 角色选择入口
- 切换后界面和权限相应变化
- 保持登录状态

### 1.4 隐私协议
**展示时机**：
- 首次登录前
- 更新隐私政策后

**内容包含**：
- 数据收集说明
- 数据使用范围
- 用户权利说明
- 联系方式

---

## 二、消息通知系统

### 2.1 通知类型
**学生接收**：
- 上课提醒（课前15分钟）
- 签到开始提醒
- 签到即将结束提醒
- 补签审批结果通知
- 考勤预警通知

**教师接收**：
- 新补签申请通知
- 学生签到异常提醒
- 系统公告

**辅导员接收**：
- 预警学生通知
- 公假审批提醒
- 周/月报提醒

**管理员接收**：
- 系统异常告警
- 用户反馈通知
- 数据备份结果

### 2.2 通知渠道
**站内消息**：
- 小程序内消息列表
- 消息角标提示
- 点击跳转到相关页面

**微信模板消息**：
- 微信服务通知
- 重要事项推送
- 可配置订阅

**短信通知**：
- 紧急事项（可选）
- 需用户授权手机号

### 2.3 消息管理
**用户功能**：
- 查看消息列表
- 标记已读/未读
- 删除消息
- 消息筛选（按类型）

**设置功能**：
- 通知开关
- 勿扰时间段
- 通知渠道选择

---

## 三、数据统计与可视化

### 3.1 统计图表类型
**常用图表**：
- 饼图：出勤情况分布
- 柱状图：各班级/课程对比
- 折线图：出勤率趋势
- 环形图：签到进度
- 排行榜：学生/课程排名

### 3.2 数据筛选
**通用筛选条件**：
- 时间范围选择
- 课程筛选
- 班级/年级筛选
- 状态筛选

### 3.3 数据导出
**导出格式**：
- Excel：详细数据表格
- PDF：图文报告
- 图片：图表截图

**导出权限**：
- 学生：仅个人数据
- 教师：所授课程数据
- 辅导员：管辖范围数据
- 管理员：全部数据

---

## 四、核心业务流程

### 4.1 签到完整流程

#### 教师端流程
```
1. 选择课程
   ↓
2. 配置签到策略
   ↓
3. 设置签到时长和范围
   ↓
4. 点击"开始签到"
   ↓
5. 生成动态二维码
   ↓
6. 实时监控签到进度
   ↓
7. 查看已签到/未签到学生
   ↓
8. 处理异常情况（手动签到）
   ↓
9. 结束签到
   ↓
10. 生成签到报告
```

#### 学生端流程（标准模式）
```
1. 收到签到通知
   ↓
2. 打开小程序，进入签到页面
   ↓
3. 自动开始定位验证
   ↓
4. 定位成功，显示距离
   ↓
5. 点击扫码按钮
   ↓
6. 扫描教师二维码
   ↓
7. 系统验证二维码有效性
   ↓
8. 验证通过，完成签到
   ↓
9. 显示签到结果
   ↓
10. 记录保存到数据库
```

### 4.2 补签完整流程

#### 学生申请流程
```
1. 进入考勤记录页面
   ↓
2. 找到缺勤记录
   ↓
3. 点击"申请补签"
   ↓
4. 选择请假类型
   ↓
5. 填写详细说明
   ↓
6. 上传证明材料（可选）
   ↓
7. 提交申请
   ↓
8. 系统生成申请记录
   ↓
9. 等待审批
```

#### 教师/辅导员审批流程
```
1. 收到补签申请通知
   ↓
2. 进入补签审批页面
   ↓
3. 查看待审批列表
   ↓
4. 点击查看申请详情
   ↓
5. 查看学生说明和证明材料
   ↓
6. 做出审批决定
   ├─ 通过：点击"通过"
   │   ↓
   │  更新考勤记录
   │   ↓
   │  发送通过通知
   │
   └─ 驳回：点击"驳回"
       ↓
      填写驳回理由
       ↓
      发送驳回通知
```

### 4.3 预警处理流程

#### 系统自动预警
```
1. 定时任务检测学生考勤
   ↓
2. 识别符合预警条件的学生
   ↓
3. 生成预警记录
   ↓
4. 推送通知给辅导员
   ↓
5. 推送提醒给学生
```

#### 辅导员跟进流程
```
1. 查看预警学生列表
   ↓
2. 点击学生查看详情
   ↓
3. 分析考勤情况
   ↓
4. 联系学生约谈
   ↓
5. 记录约谈内容
   ↓
6. 制定改进措施
   ↓
7. 标记"已跟进"
   ↓
8. 后续持续跟进
   ↓
9. 考勤改善后取消预警
```

---

## 五、异常处理机制

### 5.1 签到异常
**定位异常**：
- GPS信号弱：提示移动位置
- 定位失败：提供重试
- 距离过远：记录异常但允许签到（教师可查看）
- WiFi未连接：建议连接提高精度

**二维码异常**：
- 过期：提示刷新
- 无效：提示重新扫描
- 网络失败：自动重试

**人脸识别异常**：
- 未检测到：引导调整
- 识别失败：可重试3次
- 光线不足：提示改善环境
- 多次失败：提供人工审核入口

### 5.2 系统异常
**服务器异常**：
- 显示友好错误页面
- 提供重试按钮
- 自动上报错误日志

**数据库异常**：
- 启用备用数据库
- 数据缓存机制
- 异常恢复后数据同步

**网络异常**：
- 本地数据缓存
- 网络恢复后自动同步
- 离线提示

### 5.3 业务异常
**重复签到**：
- 检测是否已签到
- 提示已签到信息
- 阻止重复操作

**跨课程签到**：
- 验证二维码课程ID
- 阻止签到其他课程
- 记录异常行为

**时间异常**：
- 签到未开始：提示等待
- 签到已结束：提示申请补签
- 非上课时间：提示时间异常

---

## 六、数据同步机制

### 6.1 实时同步
**需要实时同步的数据**：
- 签到进度
- 动态二维码
- 签到结果
- 审批状态

**同步方式**：
- WebSocket长连接
- 消息推送
- 定时轮询（降级方案）

### 6.2 定时同步
**同步频率**：
- 课程信息：每小时同步
- 考勤记录：每10分钟同步
- 统计数据：每30分钟同步

### 6.3 手动同步
**触发场景**：
- 用户下拉刷新
- 数据异常时
- 切换页面时

---

## 七、缓存策略

### 7.1 本地缓存
**缓存内容**：
- 用户信息
- 课程列表
- 常用教室位置
- 配置参数

**缓存时效**：
- 用户信息：7天
- 课程列表：1天
- 其他数据：根据更新频率

### 7.2 缓存更新
**更新时机**：
- 数据变更时立即更新
- 缓存过期时自动更新
- 用户主动刷新时更新

### 7.3 缓存清理
**清理策略**：
- 超过时效自动清理
- 存储空间不足时清理
- 用户退出登录时清理

---

## 八、安全机制

### 8.1 数据加密
**加密范围**：
- 用户密码：不可逆加密
- 人脸数据：加密存储
- 传输数据：HTTPS加密
- 敏感接口：签名验证

### 8.2 权限验证
**验证机制**：
- 登录token验证
- 接口权限验证
- 数据权限验证
- 操作权限验证

### 8.3 防作弊机制
**技术手段**：
- 动态二维码防截图
- 定位验证防代签
- 人脸识别防替签
- 异常行为检测

**监控指标**：
- 签到时间异常
- 签到位置异常
- 设备信息异常
- 短时间多次尝试

### 8.4 日志审计
**审计内容**：
- 登录日志
- 操作日志
- 异常日志
- 安全事件日志

---

## 九、性能优化

### 9.1 前端优化
**加载优化**：
- 首屏快速渲染
- 图片懒加载
- 代码分包加载
- 骨架屏占位

**交互优化**：
- 防抖和节流
- 虚拟列表
- 异步加载
- 动画性能优化

### 9.2 后端优化
**数据库优化**：
- 索引优化
- 查询优化
- 读写分离
- 分库分表

**接口优化**：
- 接口合并
- 数据缓存
- 响应压缩
- CDN加速

### 9.3 并发处理
**高并发场景**：
- 签到开始时大量请求
- 统计报表生成
- 批量导入数据

**优化方案**：
- 消息队列
- 负载均衡
- 限流策略
- 降级方案

---

## 十、兼容性与适配

### 10.1 设备兼容
**支持设备**：
- iOS 9.0+
- Android 5.0+
- 微信版本 7.0+

### 10.2 屏幕适配
**适配方案**：
- rpx响应式单位
- 不同尺寸屏幕测试
- 横竖屏适配

### 10.3 降级方案
**功能降级**：
- 人脸识别不可用时使用其他方式
- 定位不可用时提示
- 网络较差时减少数据请求

---

## 十一、用户帮助

### 11.1 新手引导
**引导内容**：
- 首次使用功能介绍
- 关键操作步骤演示
- 常见问题提示

**引导方式**：
- 蒙层引导
- 浮层提示
- 操作视频

### 11.2 帮助文档
**文档分类**：
- 快速入门
- 功能说明
- 常见问题
- 操作视频

**访问入口**：
- 个人中心
- 页面帮助按钮
- 搜索功能

### 11.3 反馈渠道
**反馈方式**：
- 在线反馈表单
- 客服联系方式
- 用户社区

**反馈处理**：
- 自动分类
- 优先级排序
- 及时响应